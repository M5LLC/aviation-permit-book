rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================
    // Helper Functions
    // =====================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isApproved() {
      return isAuthenticated() && getUserData().status == 'approved';
    }

    function isAdmin() {
      return isApproved() && getUserData().role == 'admin';
    }

    function belongsToOrg(orgId) {
      return isApproved() && getUserData().organizationId == orgId;
    }

    function isOrgAdmin(orgId) {
      return belongsToOrg(orgId) && getUserData().role == 'admin';
    }

    // Data validation helpers
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }

    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }

    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }

    function onlyChangedFields(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }

    // =====================================
    // Organizations
    // =====================================
    match /organizations/{orgId} {
      // Members can read their organization
      allow read: if belongsToOrg(orgId);
      // Only super-admin can create/modify organizations (via Admin SDK)
      allow write: if false;

      // Organization-specific subcollections
      match /countryOverrides/{countryCode} {
        allow read: if belongsToOrg(orgId);
        allow write: if belongsToOrg(orgId) &&
          // Validate override data structure
          request.resource.data.keys().hasOnly(['overrides', 'notes', '_baseVersion', 'updatedAt', 'notesUpdatedAt']) &&
          // Notes must be reasonable length
          (!('notes' in request.resource.data) || request.resource.data.notes.size() <= 10000);
      }

      match /customHandlers/{airportCode} {
        allow read: if belongsToOrg(orgId);
        allow write: if belongsToOrg(orgId) &&
          // Validate handler data
          request.resource.data.keys().hasOnly(['handlers', 'updatedAt', 'updatedBy']) &&
          request.resource.data.handlers.size() <= 50; // Max 50 custom handlers per airport
      }
    }

    // =====================================
    // Users
    // =====================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if request.auth.uid == userId;

      // Org admins can read users in their org
      allow read: if isApproved() &&
        getUserData().organizationId == resource.data.organizationId &&
        getUserData().role == 'admin';

      // Users can update their own non-sensitive fields
      allow update: if request.auth.uid == userId &&
        isApproved() &&
        onlyChangedFields(['displayName', 'lastLogin']) &&
        (!('displayName' in request.resource.data) || isValidString(request.resource.data.displayName, 1, 100));

      // Org admins can modify users in their org (role, status)
      allow update: if isApproved() &&
        getUserData().organizationId == resource.data.organizationId &&
        getUserData().role == 'admin' &&
        // Cannot change organizationId or email
        request.resource.data.organizationId == resource.data.organizationId &&
        request.resource.data.email == resource.data.email &&
        // Can only change allowed fields
        onlyChangedFields(['role', 'status', 'displayName', 'updatedAt']) &&
        // Role must be valid
        request.resource.data.role in ['admin', 'user'] &&
        // Status must be valid
        request.resource.data.status in ['approved', 'disabled', 'pending'];

      // Users cannot delete themselves or others
      allow delete: if false;

      // New user creation is handled by Auth + Admin SDK
      allow create: if false;
    }

    // =====================================
    // Pending Users (registration requests)
    // =====================================
    match /pendingUsers/{requestId} {
      // Anyone authenticated can create a pending user request
      allow create: if isAuthenticated() &&
        request.resource.data.email == request.auth.token.email &&
        hasRequiredFields(request.resource.data, ['email', 'organizationId', 'status']) &&
        request.resource.data.status == 'pending' &&
        isValidEmail(request.resource.data.email) &&
        isValidString(request.resource.data.organizationId, 1, 100) &&
        (!('displayName' in request.resource.data) || isValidString(request.resource.data.displayName, 1, 100));

      // Org admins can read pending requests for their org
      allow read: if isApproved() &&
        getUserData().organizationId == resource.data.organizationId &&
        getUserData().role == 'admin';

      // Org admins can update (approve/deny) pending requests
      allow update: if isApproved() &&
        getUserData().organizationId == resource.data.organizationId &&
        getUserData().role == 'admin' &&
        // Can only change status fields
        onlyChangedFields(['status', 'approvedAt', 'deniedAt']) &&
        request.resource.data.status in ['approved', 'denied'];

      // Org admins can delete pending requests
      allow delete: if isApproved() &&
        getUserData().organizationId == resource.data.organizationId &&
        getUserData().role == 'admin';
    }

    // =====================================
    // Invitations
    // =====================================
    match /invitations/{inviteId} {
      // Org admins can create invitations for their org
      allow create: if isAdmin() &&
        request.resource.data.organizationId == getUserData().organizationId &&
        hasRequiredFields(request.resource.data, ['email', 'organizationId', 'invitedBy', 'status', 'token']) &&
        isValidEmail(request.resource.data.email) &&
        request.resource.data.status == 'pending' &&
        request.resource.data.invitedBy == request.auth.uid &&
        isValidString(request.resource.data.token, 20, 50);

      // Org admins can read invitations for their org
      allow read: if isAdmin() &&
        resource.data.organizationId == getUserData().organizationId;

      // Anyone authenticated can read invitations by token (for signup flow)
      // This is needed for the invitation acceptance flow
      allow read: if isAuthenticated();

      // Only the invited user can update (accept)
      allow update: if isAuthenticated() &&
        resource.data.email == request.auth.token.email &&
        request.resource.data.status == 'accepted' &&
        onlyChangedFields(['status', 'acceptedAt']);

      // Org admins can delete invitations
      allow delete: if isAdmin() &&
        resource.data.organizationId == getUserData().organizationId;
    }

    // =====================================
    // Master Data (Read-only for authenticated users)
    // =====================================
    // Note: Using isAuthenticated() instead of isApproved() so users can
    // access reference data immediately after sign-in, even if their user
    // document hasn't been created yet or is pending approval.

    match /countries/{countryCode} {
      allow read: if isAuthenticated();
      // Write only via Admin SDK (data import/refresh)
      allow write: if false;
    }

    match /airports/{airportCode} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /fbos/{airportCode} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /firs/{countryCode} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /changelog/{entryId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // =====================================
    // Suggested Updates (user contributions)
    // =====================================
    match /suggestedUpdates/{suggestionId} {
      // Any approved user can create a suggestion
      allow create: if isApproved() &&
        request.resource.data.submittedBy == request.auth.uid &&
        request.resource.data.organizationId == getUserData().organizationId &&
        hasRequiredFields(request.resource.data, ['countryCode', 'field', 'suggestedValue', 'submittedBy', 'organizationId', 'status']) &&
        request.resource.data.status == 'pending' &&
        isValidString(request.resource.data.countryCode, 2, 3) &&
        isValidString(request.resource.data.field, 1, 100) &&
        (!('reason' in request.resource.data) || isValidString(request.resource.data.reason, 0, 2000)) &&
        (!('source' in request.resource.data) || isValidString(request.resource.data.source, 0, 500));

      // Users can read their own suggestions
      allow read: if isApproved() &&
        resource.data.submittedBy == request.auth.uid;

      // Org admins can see their org's suggestions
      allow read: if isAdmin() &&
        resource.data.organizationId == getUserData().organizationId;

      // Only super-admin can update status (via Admin SDK)
      allow update: if false;
      allow delete: if false;
    }

    // =====================================
    // Catch-all: Deny everything else
    // =====================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
